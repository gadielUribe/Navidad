<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéÑ Sorpresa Navide√±a</title>
  <style>
    :root{
      --bg1:#071018;
      --bg2:#0b1a2a;
      --glow:#ffd27a;
      --text:#eaf6ff;
      --muted:#b8d2e6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 700px at 50% 20%, #12304a 0%, var(--bg2) 45%, var(--bg1) 100%);
      overflow-x:hidden;
      overflow-y:auto;
      min-height:100vh;
    }

    /* Fondo bosque */
    .forest{
      position:fixed; inset:auto 0 0 0;
      height:42vh;
      opacity:.9;
      filter: blur(.0px);
      pointer-events:none;
      z-index:0;
    }
    .forest svg{width:100%; height:100%}
    .forest .layer1{opacity:.35}
    .forest .layer2{opacity:.55}
    .forest .layer3{opacity:.75}
    .forest path{
      fill:#07121c;
    }

    .ground{
      position:fixed; left:50%; bottom:-10vh;
      width:min(1200px, 140vw);
      height:40vh;
      transform: translateX(-50%);
      background: radial-gradient(60% 60% at 50% 35%, rgba(255,255,255,.06), transparent 65%),
                  radial-gradient(70% 70% at 50% 75%, rgba(0,0,0,.35), transparent 70%);
      border-radius: 50%;
      pointer-events:none;
      z-index:1;
    }

    /* contenedor */
    .wrap{
      position:relative;
      z-index:2;
      display:grid;
      place-items:center;
      min-height:100vh;
      padding: clamp(12px, 3vw, 24px);
    }
    .scene{
      position:relative;
      width:min(1100px, 100%);
      min-height:min(640px, 86vh);
      height:auto;
      display:grid;
      grid-template-columns: minmax(240px, 340px) 1fr;
      align-items:end;
      justify-items:center;
      gap:min(6vw, 44px);
      padding: clamp(10px, 2vw, 18px) 12px 28px;
    }

    .treeWrap{
      position:relative;
      width:clamp(320px, 64vw, 560px);
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding-bottom:8px;
    }

    /* Tip arriba */
    .tip{
      position:absolute;
      top:14px; left:50%; transform:translateX(-50%);
      padding:10px 14px;
      background: rgba(20,30,45,.55);
      border:1px solid rgba(255,255,255,.16);
      border-radius:999px;
      backdrop-filter: blur(10px);
      font-size:14px;
      color:var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      max-width:min(640px, 90vw);
      text-align:center;
      justify-content:center;
      align-items:center;
      z-index:10;
      box-shadow: 0 20px 40px rgba(0,0,0,.35);
    }
    .tip .dot{
      width:10px;height:10px;border-radius:50%;
      background: radial-gradient(circle at 35% 35%, #7ff 0 35%, #2aa 70%);
      box-shadow: 0 0 18px rgba(120,255,255,.45);
    }

    /* Texto Feliz Navidad (posicionado sobre el mu√±eco sin mover nada) */
    .felizNavidad{
      position:absolute;
      z-index:9;
      pointer-events:none;
      color:#fff;
      font-family: "Georgia", "Times New Roman", serif;
      font-weight:700;
      letter-spacing:.8px;
      font-size: clamp(34px, 5vw, 52px);
      text-shadow:
        0 2px 0 rgba(0,0,0,.25),
        0 10px 24px rgba(0,0,0,.45),
        0 0 18px rgba(255,255,255,.18);
      filter: drop-shadow(0 0 18px rgba(255,255,255,.08));
      opacity:.95;
      transform: translateZ(0);
      white-space: nowrap;
    }

    /* √Årbol (SVG) */
    .tree{
      position:relative;
      width:clamp(260px, 52vw, 430px);
      height:auto;
      max-height:min(580px, 74vh);
      aspect-ratio:3/4;
      display:grid;
      place-items:center;
      z-index:5;
      transform: translateY(-10px);
      margin-top:0;
    }
    .tree svg{width:100%; height:100%; overflow:visible}
    .starGlow{
      filter: drop-shadow(0 0 18px rgba(255,210,122,.55))
              drop-shadow(0 0 50px rgba(255,210,122,.25));
    }

    /* ‚ÄúLuz‚Äù dibujando el √°rbol */
    .draw-line{
      fill:none;
      stroke: rgba(255,210,140,.92);
      stroke-width: 10;
      stroke-linecap: round;
      stroke-linejoin: round;
      filter: drop-shadow(0 0 12px rgba(255,210,140,.55));
      stroke-dasharray: var(--dash, 2000);
      stroke-dashoffset: var(--dash, 2000);
      animation: draw 2.6s ease-out forwards;
    }
    @keyframes draw{
      to{ stroke-dashoffset: 0; }
    }

    /* contorno suave detr√°s para volumen */
    .tree-body{
      fill:none;
      stroke: rgba(120,255,220,.10);
      stroke-width: 18;
      filter: blur(.1px);
    }
    /* luces dentro */
    .bulb{
      filter: drop-shadow(0 0 14px rgba(255,255,255,.25));
      opacity:.95;
      animation: bulbsIn .45s ease-out both;
    }
    @keyframes bulbsIn{
      from{transform:scale(.7); opacity:0}
      to{transform:scale(1); opacity:1}
    }
    .twinkle{
      animation: twinkle 1.2s ease-in-out infinite;
    }
    @keyframes twinkle{
      0%,100%{ opacity:.55; transform:scale(.95) }
      50%{ opacity:1; transform:scale(1.12) }
    }

    /* Mu√±eco de nieve (no tapa ojos) */
    .snowman{
      width:clamp(180px, 32vw, 280px);
      height:auto;
      z-index:4;
      transform: translateY(8px);
      filter: drop-shadow(0 20px 35px rgba(0,0,0,.35));
    }

    /* Regalos */
    .gifts{
      position:relative;
      width:min(420px, 72vw);
      height:190px;
      margin-top:18px; /* coloca los regalos a la altura del tronco */
      z-index:6;
    }
    .gift{
      position:absolute;
      width:92px; height:92px;
      border-radius:14px;
      cursor:pointer;
      box-shadow: 0 16px 30px rgba(0,0,0,.35);
      transition: transform .18s ease, filter .18s ease;
      user-select:none;
      outline:none;
    }
    .gift:hover{
      transform: translateY(-6px) rotate(var(--r)) scale(1.03);
      filter: saturate(1.25) brightness(1.05);
    }
    .gift::before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.35), transparent 55%);
      transform: rotate(20deg);
    }
    .gift .ribbonV, .gift .ribbonH{
      position:absolute; background: rgba(255,255,255,.72);
      mix-blend-mode: screen;
      filter: drop-shadow(0 0 6px rgba(255,255,255,.25));
    }
    .gift .ribbonV{width:18px; height:100%; left:50%; transform:translateX(-50%)}
    .gift .ribbonH{height:18px; width:100%; top:50%; transform:translateY(-50%)}
    .gift .bow{
      position:absolute; left:50%; top:18px;
      width:38px; height:22px;
      transform: translateX(-50%);
    }
    .gift .bow:before, .gift .bow:after{
      content:"";
      position:absolute; inset:0;
      border-radius: 999px 999px 999px 999px;
      background: rgba(255,255,255,.75);
      width:22px; height:14px;
      top:4px;
      filter: drop-shadow(0 0 10px rgba(255,255,255,.25));
    }
    .gift .bow:before{left:0; transform: rotate(18deg)}
    .gift .bow:after{right:0; transform: rotate(-18deg)}

    /* nieve */
    #snow{
      position:fixed; inset:0;
      z-index:2;
      pointer-events:none;
    }

    /* Modal tarjeta */
    .modal{
      position:fixed; inset:0;
      display:grid;
      place-items:center;
      background: rgba(5,10,16,.55);
      backdrop-filter: blur(10px);
      opacity:0; pointer-events:none;
      transition: opacity .25s ease;
      z-index:50;
      padding:18px;
    }
    .modal.open{opacity:1; pointer-events:auto}
    .card{
      width:min(720px, 96vw);
      border-radius:22px;
      background: rgba(18,26,40,.74);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 40px 90px rgba(0,0,0,.55);
      overflow:hidden;
      position:relative;
    }
    .card header{
      padding:18px 18px 10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 12px; border-radius:999px;
      background: rgba(255,255,255,.09);
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      font-size:13px;
    }
    .close{
      appearance:none;
      border:none;
      background: rgba(255,255,255,.08);
      color:var(--text);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease;
    }
    .close:hover{background: rgba(255,255,255,.12); transform: translateY(-1px)}
    .card main{
      padding: 6px 18px 18px;
    }
    .card h2{
      margin:10px 0 8px;
      font-size: clamp(26px, 4.2vw, 40px);
      letter-spacing:.2px;
    }
    .msg{
      margin:0;
      color:rgba(234,246,255,.92);
      font-size: clamp(15px, 2.1vw, 18px);
      line-height:1.6;
      max-width: 62ch;
    }
    .sparkleLine{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(255,210,122,.55), transparent);
      margin: 12px 0 12px;
      border-radius:999px;
    }

    /* Fuegos artificiales/confetti (canvas) */
    #fx{
      position:fixed; inset:0;
      z-index:60;
      pointer-events:none;
    }

    @media (max-width: 980px){
      body{background-size:160% auto;}
      .scene{
        grid-template-columns: 1fr;
        align-items:center;
        justify-items:center;
        min-height:auto;
        height:auto;
        gap:18px;
        padding: clamp(14px, 3vw, 22px);
      }
      .treeWrap{width:min(520px, 92vw);}
      .tree{width:min(380px, 85vw); max-height:70vh;}
      .gifts{
        width:100%;
        height:auto;
        display:grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap:12px;
        padding:6px 2px 2px;
        margin-top:-6px;
      }
      .gift{
        position:relative;
        left:auto !important;
        top:auto !important;
        width:100%;
        height:120px;
        transform:none !important;
      }
      .gift::before{inset:-30%;}
    }

    @media (max-width: 620px){
      .treeWrap{width:min(460px, 94vw);}
      .tree{width:min(320px, 90vw);}
      .tip{font-size:13px; padding:10px 12px;}
      .gifts{grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:10px;}
      .gift{height:110px;}
    }

    @media (max-height: 680px){
      .scene{min-height:auto; padding-bottom:16px;}
      .tree{max-height:60vh;}
      .ground{height:32vh;}
    }

    @media (max-width: 760px){
      .scene{grid-template-columns: 1fr; gap:12px; padding: clamp(12px, 3vw, 18px);}
      .snowman{display:none;} /* en m√≥vil prioriza el √°rbol */
      .treeWrap{width:min(440px, 94vw);}
      .tree{max-height:65vh;}
      .gifts{margin-top:0;}
      .felizNavidad{display:none;} /* si se oculta el mu√±eco, oculta el texto */
    }
  </style>
</head>
<body>

<canvas id="snow"></canvas>
<canvas id="fx"></canvas>

<div class="forest" aria-hidden="true">
  <svg viewBox="0 0 1200 400" preserveAspectRatio="none">
    <g class="layer3">
      <path d="M0,330 C120,290 220,320 330,290 C460,250 560,300 690,270 C820,240 910,290 1040,270 C1120,255 1160,265 1200,260 L1200,400 L0,400 Z"/>
      <path d="M60,340 l30,-85 l30,85 z M150,350 l35,-105 l35,105 z M270,348 l32,-96 l32,96 z
               M420,350 l40,-120 l40,120 z M560,348 l36,-110 l36,110 z M720,350 l38,-120 l38,120 z
               M910,350 l34,-100 l34,100 z M1050,348 l40,-130 l40,130 z"/>
    </g>
    <g class="layer2">
      <path d="M0,340 C140,300 250,330 360,300 C520,260 610,320 760,295 C910,270 1000,305 1130,285 C1168,280 1188,282 1200,280 L1200,400 L0,400 Z"/>
      <path d="M90,355 l26,-70 l26,70 z M210,360 l30,-84 l30,84 z M340,362 l28,-80 l28,80 z
               M520,360 l34,-100 l34,100 z M700,362 l30,-92 l30,92 z M860,360 l34,-104 l34,104 z"/>
    </g>
    <g class="layer1">
      <path d="M0,355 C160,325 280,350 410,325 C600,290 710,340 870,320 C1030,300 1100,320 1200,310 L1200,400 L0,400 Z"/>
      <path d="M120,368 l22,-55 l22,55 z M320,372 l24,-62 l24,62 z M620,370 l28,-75 l28,75 z M980,370 l26,-70 l26,70 z"/>
    </g>
  </svg>
</div>

<div class="ground" aria-hidden="true"></div>

<div class="wrap">
  <div class="scene" id="sceneRoot">
    <div class="tip"><span class="dot"></span> Da click en los regalos üéÅ para abrir tu tarjeta</div>

    <!-- Feliz Navidad (se coloca encima del mu√±eco con JS) -->
    <div class="felizNavidad" id="felizNavidad" aria-hidden="true">Feliz Navidad</div>

    <!-- Mu√±eco de nieve (SVG) -->
    <svg class="snowman" id="snowman" viewBox="0 0 260 340" aria-label="Mu√±eco de nieve">
      <defs>
        <radialGradient id="snowGrad" cx="35%" cy="25%">
          <stop offset="0" stop-color="#ffffff"/>
          <stop offset="1" stop-color="#cfe6ff"/>
        </radialGradient>
        <linearGradient id="scarf" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0" stop-color="#ff4b4b"/>
          <stop offset="1" stop-color="#ffb86b"/>
        </linearGradient>
        <linearGradient id="hatBand" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0" stop-color="#ff3f8f"/>
          <stop offset=".5" stop-color="#7c5cff"/>
          <stop offset="1" stop-color="#1bd2ff"/>
        </linearGradient>
      </defs>

      <ellipse cx="130" cy="330" rx="92" ry="18" fill="rgba(0,0,0,.25)"/>

      <circle cx="130" cy="230" r="88" fill="url(#snowGrad)"/>
      <circle cx="130" cy="120" r="64" fill="url(#snowGrad)"/>

      <circle cx="130" cy="190" r="6" fill="#14202b" opacity=".8"/>
      <circle cx="130" cy="230" r="6" fill="#14202b" opacity=".8"/>
      <circle cx="130" cy="270" r="6" fill="#14202b" opacity=".8"/>

      <circle cx="112" cy="112" r="7" fill="#0b0f14"/>
      <circle cx="148" cy="112" r="7" fill="#0b0f14"/>

      <path d="M118 135 Q130 145 142 135" fill="none" stroke="#0b0f14" stroke-width="4" stroke-linecap="round"/>

      <path d="M132 115 L178 125 L132 135 Z" fill="#ff8a2b" stroke="#e26c0f" stroke-width="2" />

      <!-- bufanda (bajada para no tapar cara) -->
      <path d="M74 160 C92 182 168 182 186 160 C172 140 88 140 74 160 Z" fill="url(#scarf)"/>
      <path d="M170 162 C190 166 200 186 192 212 C184 240 156 236 154 214 C152 192 156 168 170 162 Z" fill="url(#scarf)"/>

      <!-- sombrero -->
      <rect x="78" y="30" width="104" height="60" rx="12" fill="#0b0f14"/>
      <rect x="70" y="78" width="120" height="16" rx="8" fill="#0b0f14"/>
      <rect x="78" y="68" width="104" height="14" rx="7" fill="url(#hatBand)" opacity=".95"/>
    </svg>

    <!-- √Årbol (SVG con animaci√≥n de ‚Äútrazo de luz‚Äù) -->
    <div class="treeWrap" aria-label="√Årbol y regalos">
      <div class="tree" aria-label="√Årbol de navidad animado">
        <svg viewBox="0 0 420 640">
          <defs>
            <clipPath id="treeClip">
              <path id="treeShape"
                d="M210 88
                   C235 118 280 145 305 170
                   C285 175 260 178 244 182
                   C270 210 318 240 340 266
                   C314 272 284 276 265 280
                   C292 312 336 346 360 382
                   C325 389 290 395 268 398
                   C295 440 330 480 354 512
                   C300 520 250 524 210 524
                   C170 524 120 520 66 512
                   C90 480 125 440 152 398
                   C130 395 95 389 60 382
                   C84 346 128 312 155 280
                   C136 276 106 272 80 266
                   C102 240 150 210 176 182
                   C160 178 135 175 115 170
                   C140 145 185 118 210 88 Z" />
            </clipPath>

            <radialGradient id="star" cx="30%" cy="25%">
              <stop offset="0" stop-color="#fff4cc"/>
              <stop offset="1" stop-color="#ffd27a"/>
            </radialGradient>

            <linearGradient id="trunk" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0" stop-color="#7a4b2a"/>
              <stop offset="1" stop-color="#4a2b17"/>
            </linearGradient>

            <filter id="softGlow" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="3" result="b"/>
              <feMerge>
                <feMergeNode in="b"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>

          <g class="starGlow">
            <path fill="url(#star)" d="M210 22 L224 58 L262 58 L232 80 L244 116 L210 94 L176 116 L188 80 L158 58 L196 58 Z"/>
          </g>

          <rect x="182" y="520" width="56" height="78" rx="10" fill="url(#trunk)" opacity=".95"/>

          <path class="tree-body"
            d="M210 88
               C235 118 280 145 305 170
               C285 175 260 178 244 182
               C270 210 318 240 340 266
               C314 272 284 276 265 280
               C292 312 336 346 360 382
               C325 389 290 395 268 398
               C295 440 330 480 354 512
               C300 520 250 524 210 524
               C170 524 120 520 66 512
               C90 480 125 440 152 398
               C130 395 95 389 60 382
               C84 346 128 312 155 280
               C136 276 106 272 80 266
               C102 240 150 210 176 182
               C160 178 135 175 115 170
               C140 145 185 118 210 88 Z" />

          <path id="drawPath" class="draw-line"
            d="M210 88
               C235 118 280 145 305 170
               C285 175 260 178 244 182
               C270 210 318 240 340 266
               C314 272 284 276 265 280
               C292 312 336 346 360 382
               C325 389 290 395 268 398
               C295 440 330 480 354 512
               C300 520 250 524 210 524
               C170 524 120 520 66 512
               C90 480 125 440 152 398
               C130 395 95 389 60 382
               C84 346 128 312 155 280
               C136 276 106 272 80 266
               C102 240 150 210 176 182
               C160 178 135 175 115 170
               C140 145 185 118 210 88 Z" />

          <g id="bulbs" clip-path="url(#treeClip)"></g>

          <g clip-path="url(#treeClip)" opacity=".18">
            <ellipse cx="210" cy="310" rx="170" ry="210" fill="rgba(80,255,200,.35)" filter="url(#softGlow)"/>
          </g>
        </svg>
      </div>

      <!-- regalos -->
      <div class="gifts" aria-label="Regalos">
        <div class="gift" data-title="Mi persona favorita ‚ú®" data-msg="Gracias por existir.\nPor tu ternura, por tu paciencia y por hacer especial lo cotidiano.\nQue esta Navidad brille fuerte para ti‚Ä¶ y que nunca te falte amor, ilusi√≥n y motivos para sonre√≠r.\nYo aqu√≠, contigo. ‚ù§Ô∏èüéÑ"
             style="--r:-10deg; left:18%; top:52px; transform: rotate(-10deg); background: linear-gradient(135deg,#ff6a6a,#ffcc6a);">
          <div class="ribbonV"></div><div class="ribbonH"></div><div class="bow"></div>
        </div>
        <div class="gift" data-title="Un deseo para ti ‚≠ê" data-msg="Esta Navidad quiero pedir algo:\nque la vida te trate suave,\nque tus sue√±os se te acerquen,\ny que nunca te falte amor.\n\n(Y si alg√∫n d√≠a dudas, yo te lo recuerdo: eres maravillosa) üíõ"
             style="--r:3deg; left:38%; top:36px; transform: rotate(3deg); background: linear-gradient(135deg,#4dc2ff,#7a5cff);">
          <div class="ribbonV"></div><div class="ribbonH"></div><div class="bow"></div>
        </div>
        <div class="gift" data-title="Mi lugar favorito üíô" data-msg="Mi lugar favorito no es un sitio‚Ä¶\nes cuando est√°s cerca.\n\nQue esta noche se llene de calma,\nlucecitas bonitas,\ny de todo lo lindo que mereces. ‚ú®üéÅ"
             style="--r:-6deg; left:56%; top:50px; transform: rotate(-6deg); background: linear-gradient(135deg,#4dffcc,#2bb673);">
          <div class="ribbonV"></div><div class="ribbonH"></div><div class="bow"></div>
        </div>
        <div class="gift" data-title="Para siempre contigo üíñ" data-msg="Gracias por acompa√±arme,\npor inspirarme,\ny por hacer que el amor se sienta hogar.\n\nFeliz Navidad, mi vida.\nQue todo lo bonito nos encuentre. ‚ú®üéÑ"
             style="--r:12deg; left:69%; top:34px; transform: rotate(12deg); background: linear-gradient(135deg,#ff73d4,#7a5cff);">
          <div class="ribbonV"></div><div class="ribbonH"></div><div class="bow"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal -->
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Tarjeta navide√±a">
  <div class="card">
    <header>
      <span class="pill" id="pill">üéÑ Para ti</span>
      <button class="close" id="closeBtn">Cerrar ‚úï</button>
    </header>
    <main>
      <h2 id="cardTitle">Feliz Navidad</h2>
      <div class="sparkleLine"></div>
      <p class="msg" id="cardMsg">Mensaje</p>
    </main>
  </div>
</div>

<script>
  // ---------- √Årbol: ajustar dash para que el trazo se dibuje completo ----------
  const drawPath = document.getElementById('drawPath');
  const length = drawPath.getTotalLength();
  drawPath.style.setProperty('--dash', length);

  // ---------- Luces del √°rbol (dentro del clip) ----------
  const bulbs = document.getElementById('bulbs');
  const colors = ["#ff5b5b","#ffd76a","#63ffa6","#63d6ff","#b77bff","#ffffff"];
  const pts = [
    [210,140],[250,160],[170,168],[290,205],[130,210],
    [210,230],[250,250],[160,255],[305,290],[110,300],
    [210,320],[260,340],[150,352],[295,380],[120,392],
    [210,410],[250,440],[165,460],[280,490],[140,500]
  ];
  pts.forEach((p,i)=>{
    const [x,y]=p;
    const c = colors[i % colors.length];
    const r = 8 + (i%3)*2;
    const b = document.createElementNS("http://www.w3.org/2000/svg","circle");
    b.setAttribute("cx", x);
    b.setAttribute("cy", y);
    b.setAttribute("r", r);
    b.setAttribute("fill", c);
    b.setAttribute("class", "bulb twinkle");
    b.style.animationDelay = (0.15*i)+"s";
    bulbs.appendChild(b);
  });

  // ---------- Nieve (canvas) ----------
  const snow = document.getElementById('snow');
  const sctx = snow.getContext('2d');
  let W,H,flakes=[];
  function resize(){
    W = snow.width = window.innerWidth * devicePixelRatio;
    H = snow.height = window.innerHeight * devicePixelRatio;
  }
  window.addEventListener('resize', resize);
  resize();

  function initSnow(){
    flakes = Array.from({length: 190}, ()=>({
      x: Math.random()*W,
      y: Math.random()*H,
      r: (1+Math.random()*2.6)*devicePixelRatio,
      vy: (0.5+Math.random()*1.6)*devicePixelRatio,
      vx: (-0.3+Math.random()*0.6)*devicePixelRatio,
      a: 0.35 + Math.random()*0.6
    }));
  }
  initSnow();

  function snowTick(){
    sctx.clearRect(0,0,W,H);
    sctx.fillStyle = "rgba(255,255,255,0.9)";
    for(const f of flakes){
      f.y += f.vy;
      f.x += f.vx + Math.sin(f.y*0.002)*0.25*devicePixelRatio;
      if(f.y > H+20) { f.y = -20; f.x = Math.random()*W; }
      if(f.x > W+20) f.x = -20;
      if(f.x < -20) f.x = W+20;
      sctx.globalAlpha = f.a;
      sctx.beginPath();
      sctx.arc(f.x,f.y,f.r,0,Math.PI*2);
      sctx.fill();
    }
    requestAnimationFrame(snowTick);
  }
  snowTick();

  // ---------- Modal + fuegos artificiales ----------
  const modal = document.getElementById('modal');
  const closeBtn = document.getElementById('closeBtn');
  const cardTitle = document.getElementById('cardTitle');
  const cardMsg = document.getElementById('cardMsg');
  const pill = document.getElementById('pill');

  // FX canvas
  const fx = document.getElementById('fx');
  const fctx = fx.getContext('2d');
  function resizeFx(){
    fx.width = innerWidth * devicePixelRatio;
    fx.height = innerHeight * devicePixelRatio;
  }
  addEventListener('resize', resizeFx);
  resizeFx();

  let particles=[];
  function burst(x,y){
    const count = 42;
    for(let i=0;i<count;i++){
      const a = Math.random()*Math.PI*2;
      const sp = (2+Math.random()*5.5)*devicePixelRatio;
      particles.push({
        x,y,
        vx: Math.cos(a)*sp,
        vy: Math.sin(a)*sp - 1.5*devicePixelRatio,
        life: 60 + Math.random()*25,
        r: (2+Math.random()*3.5)*devicePixelRatio,
        c: ["#ff5b5b","#ffd76a","#63ffa6","#63d6ff","#b77bff","#ffffff"][Math.floor(Math.random()*6)]
      });
    }
  }
  function fxTick(){
    fctx.clearRect(0,0,fx.width,fx.height);
    for(const p of particles){
      p.life -= 1;
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.06*devicePixelRatio;
      p.vx *= 0.985;
      p.vy *= 0.985;
      fctx.globalAlpha = Math.max(0, p.life/90);
      fctx.fillStyle = p.c;
      fctx.beginPath();
      fctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      fctx.fill();
    }
    particles = particles.filter(p=>p.life>0);
    requestAnimationFrame(fxTick);
  }
  fxTick();

  function openCard(giftEl){
    const title = giftEl.dataset.title || "Feliz Navidad";
    const msg = giftEl.dataset.msg || "üíñ";
    cardTitle.textContent = title;

    // Renderiza saltos de l√≠nea:
    // - \n (newline real)
    // - \\n (texto literal "\n" que aparece en HTML attributes)
    const safe = msg
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');

    cardMsg.innerHTML = safe.replace(/\\n|\n/g,'<br>');

    pill.textContent = "üéÑ Para ti";
    modal.classList.add('open');

    const rect = giftEl.getBoundingClientRect();
    const px = (rect.left + rect.width/2) * devicePixelRatio;
    const py = (rect.top + rect.height/2) * devicePixelRatio;
    burst(px, py);
    setTimeout(()=>burst(px, py - 120*devicePixelRatio), 120);
  }

  function closeCard(){
    modal.classList.remove('open');
  }

  document.querySelectorAll('.gift').forEach(g=>{
    g.addEventListener('click', ()=>openCard(g));
  });

  closeBtn.addEventListener('click', closeCard);
  modal.addEventListener('click', (e)=>{ if(e.target === modal) closeCard(); });
  addEventListener('keydown', (e)=>{ if(e.key === "Escape") closeCard(); });

  // ---------- Peque√±o ‚Äúpop‚Äù al terminar el dibujo ----------
  drawPath.addEventListener('animationend', ()=>{
    document.querySelector('.starGlow').animate(
      [{transform:'scale(1)', filter:'drop-shadow(0 0 18px rgba(255,210,122,.55))'},
       {transform:'scale(1.08)', filter:'drop-shadow(0 0 32px rgba(255,210,122,.75))'},
       {transform:'scale(1)', filter:'drop-shadow(0 0 18px rgba(255,210,122,.55))'}],
      {duration: 900, easing:'ease-out'}
    );
  });

  // ---------- Posicionar "Feliz Navidad" encima del mu√±eco (sin mover el layout) ----------
  const feliz = document.getElementById('felizNavidad');
  const snowmanEl = document.getElementById('snowman');
  const sceneRoot = document.getElementById('sceneRoot');

  function positionFeliz(){
    // si el mu√±eco est√° oculto (mobile), oculta el texto tambi√©n
    const snowmanStyle = getComputedStyle(snowmanEl);
    if (snowmanStyle.display === 'none'){
      feliz.style.display = 'none';
      return;
    }
    feliz.style.display = 'block';

    const sRect = snowmanEl.getBoundingClientRect();
    const cRect = sceneRoot.getBoundingClientRect();

    // Asegura que el elemento tenga tama√±o calculado
    const fw = feliz.offsetWidth || 0;
    const fh = feliz.offsetHeight || 0;

    const centerX = (sRect.left + sRect.right) / 2;
    const topY = sRect.top;

    // Posici√≥n relativa al contenedor .scene
    const left = centerX - cRect.left - (fw / 2);
    const top = topY - cRect.top - fh - 10; // 10px de separaci√≥n

    feliz.style.left = `${Math.max(8, left)}px`;
    feliz.style.top  = `${Math.max(8, top)}px`;
  }

  // Llama cuando cargue y al redimensionar
  window.addEventListener('load', positionFeliz);
  window.addEventListener('resize', positionFeliz);

  // Tambi√©n despu√©s de un peque√±o delay por fuentes/render
  setTimeout(positionFeliz, 100);
  setTimeout(positionFeliz, 350);
</script>
</body>
</html>

